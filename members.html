<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" type="image/png" href="assets/images/logo2.PNG">
        <title>Davao Blue Eagle Scout - Cirva A La Gente Por La Musica</title>
        <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,800,900&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link href="assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <link href="assets/plugins/font-awesome/css/all.min.css" rel="stylesheet">
        <link href="assets/css/style.css" rel="stylesheet">
        <link href="assets/css/custom.css" rel="stylesheet">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <style>
            select {
                appearance: none;
                -webkit-appearance: none;
                -moz-appearance: none;
            }
            .status-active { color: #28a745; }
            .status-inactive { color: #dc3545; }
        </style>
        <script type="text/javascript">
            if (!localStorage.getItem("user")) {
                window.location.href = "login";
            }    

            document.addEventListener("DOMContentLoaded", function() {
                const currentUrl = window.location.href;
                const links = document.querySelectorAll('.accordion-menu a');

                links.forEach(link => {
                    if (currentUrl.includes(link.getAttribute('href'))) {
                        link.classList.add('active');
                    }
                });
            });
        </script>
    </head>
    <body>
        <div style="position: fixed;top: 0px;left: 0px;width: 100%;background: #F4F7FC;z-index: 9999;padding: 0px;">
            <div class="lime-sidebar">
                <div class="lime-sidebar-inner slimscroll">
                    <ul class="accordion-menu">
                        <li class="sidebar-title">Navigations</li>
                        <li><a href="dashboard"><i class="material-icons">dashboard</i><span>Dashboard</span></a></li>
                        <li><a href="events"><i class="material-icons">event</i><span>Events</span></a></li>
                        <li><a href="revenues"><i class="material-icons">trending_up</i><span>Revenues</span></a></li>
                        <li><a href="payments"><i class="material-icons">payment</i><span>Payments</span></a></li>
                        <li><a href="expenses"><i class="material-icons">request_quote</i><span>Expenses</span></a></li>
                        <li><a href="officers"><i class="material-icons">people</i><span>Officers</span></a></li>
                        <li><a href="login_history"><i class="material-icons">schedule</i><span>Login History</span></a></li>
                        <li><a href="summary"><i class="material-icons">bar_chart</i>Summary</a></li>
                        <li><a href="members"><i class="material-icons">people</i><span>Members</span></a></li>
                    </ul>
                    <ul class="accordion-menu" id="Othersnav">
                        <li class="divider"></li>
                        <li class="sidebar-title">Others</li>
                        <li><a href="dashboard"><i class="material-icons">settings</i><span>Account</span></a></li>
                        <li><a onclick="localStorage.removeItem('user'); window.location.href = 'login';"><i class="material-icons">power_settings_new</i><span>Logout</span></a></li>
                    </ul>
                </div>
            </div>

            <style>
                @media (max-width: 1024px) {
                    #Othersnav {
                        display: block;
                    }
                }
                @media (min-width: 1025px) {
                    #Othersnav {
                        display: none;
                    }
                }
            </style>

            <div class="lime-header" style="padding: 0px;">
                <nav class="navbar navbar-expand-lg">
                    <section class="material-design-hamburger navigation-toggle">
                        <a href="javascript:void(0)" class="button-collapse material-design-hamburger__icon">
                            <span class="material-design-hamburger__layer"></span>
                        </a>
                    </section>
                    <a class="navbar-brand" href="">
                        <img src="assets/images/logo2.png" style="height: 75px;width: 75px;">
                    </a>
                    <button class="navbar-toggler" type="button" style="margin-right: 10px" onclick="localStorage.removeItem('user'); window.location.href = 'login';">
                        <i class="material-icons" style="font-size: 20px;">power_settings_new</i>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav ml-auto">
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="material-icons">more_vert</i>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-right">
                                    <li><a class="dropdown-item" href="#">Account</a></li>
                                    <li><a class="dropdown-item" onclick="localStorage.removeItem('user'); window.location.href = 'index.html';">Log Out</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>
        </div>

        <div class="lime-container">
            <div class="lime-body" style="margin-top:100px">
                <div class="container">
                    <div class="row">
                        <div class="col">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title" style="text-align: center;">(<span style="color:#07102F" id="totalRows"></span>) Members</h5>
                                    <div class="row">
                                        <div class="col-12 col-md-12">
                                            <div class="todo-sidebar">
                                                <div class="row">
                                                    <div class="col-12 col-md-6 mb-3">
                                                        <div class="todo-new-task">
                                                            <button class="btn btn-primary btn-block" style="height:42px;" data-toggle="modal" data-target="#newMemberModal">Create New Member</button>
                                                        </div>
                                                    </div>
                                                    <div class="col-12 col-md-6 mb-3">
                                                        <div class="todo-search m-b-lg">
                                                            <div class="input-group">
                                                                <input type="text" id="search" class="form-control" placeholder="Search Members">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-md-12">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="card stat-card">
                                                        <div class="card-body bg-info">
                                                            <h5 class="card-title">Total Active Members</h5>
                                                            <h2 class="float-right" id="totalActive" style="color:white;"></h2>
                                                            <p style="color:white;font-weight: bold;">MEMBERS</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="card stat-card">
                                                        <div class="card-body bg-warning">
                                                            <h5 class="card-title">Total Inactive Members</h5>
                                                            <h2 class="float-right" id="totalInactive" style="color:white;"></h2>
                                                            <p style="color:white;font-weight: bold;">MEMBERS</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="card">
                                                <div class="card-body" style="padding: 0px;">
                                                    <div class="table-responsive">
                                                        <table class="table" id="memberTableData">
                                                            <thead>
                                                                <tr>
                                                                    <th>Name</th>
                                                                    <th>Role</th>
                                                                    <th>Status</th>
                                                                    <th>Description</th>
                                                                    <th>Actions</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="memberTableBody"></tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lime-footer">
                <div class="container">
                    <div class="row">
                        <div class="col-md-12">
                            <span class="footer-text">2025 © Davao Blue Eagle Scout</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Password Confirm Modal -->
        <div class="modal fade" id="passwordConfirmModal" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style="z-index: 99999999;background: rgba(0, 0, 0, 0.5);">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirm Deletion</h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>
                            Are you sure you want to delete this expense? <br>
                            <em>All related data including revenues, expenses, payments, and records will also be deleted.</em>
                        </p>
                        <div class="form-group">
                            <label for="deletePassword">To confirm, type your password below</label>
                            <input type="password" class="form-control" id="deletePassword" placeholder="Password">
                            <br>
                            <strong style="color:#FC6060">This action cannot be undone.</strong><br>
                        </div>
                        <div id="passwordError" class="text-danger" style="display: none;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="dummy_confirmDeleteBtn" disabled style="margin-right: -8px;">Delete</button>
                        <form id="deleteForm">
                            <input type="hidden" id="idtodelete" name="idtodelete">
                            <button type="submit" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Member Modal -->
        <div class="modal fade" id="newMemberModal" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style="z-index: 99999999;background: rgba(0, 0, 0, 0.5);">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Create New Member</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <i class="material-icons">close</i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="newMemberForm">
                            <div class="form-group">
                                <label>Name</label>
                                <input type="text" class="form-control" id="memberName" name="name" required>
                            </div>
                            <div class="form-group">
                                <label>Role</label>
                                <input type="text" class="form-control" id="memberRole" name="role" required>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select class="form-control" id="memberStatus" name="status" required>
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="form-control" id="memberDescription" name="description" rows="3"></textarea>
                            </div>
                            <div class="modal-footer" style="padding-right: 0px;">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Add Member</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Member Modal -->
        <div class="modal fade" id="editMemberModal" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style="z-index: 99999999;background: rgba(0, 0, 0, 0.5);">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Edit Member</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <i class="material-icons">close</i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="editMemberForm">
                            <input type="hidden" id="edit_memberId" name="member_id">
                            <div class="form-group">
                                <label>Name</label>
                                <input type="text" class="form-control" id="edit_memberName" name="name" required>
                            </div>
                            <div class="form-group">
                                <label>Role</label>
                                <input type="text" class="form-control" id="edit_memberRole" name="role" required>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select class="form-control" id="edit_memberStatus" name="status" required>
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="form-control" id="edit_memberDescription" name="description" rows="3"></textarea>
                            </div>
                            <div class="modal-footer" style="padding-right: 0px;">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Javascripts -->
        <script src="assets/plugins/jquery/jquery-3.1.0.min.js"></script>
        <script src="assets/plugins/bootstrap/popper.min.js"></script>
        <script src="assets/plugins/bootstrap/js/bootstrap.min.js"></script>
        <script src="assets/plugins/jquery-slimscroll/jquery.slimscroll.min.js"></script>
        <script src="assets/js/lime.min.js"></script>
        
        <script>
            $(document).ready(function() {
                // Load all members
                function loadMembers() {
                    $.get("/allmembers", function(response) {
                        if (response.status === "error") {
                            alert("Error loading members: " + response.message);
                            return;
                        }

                        const tableBody = $("#memberTableBody");
                        tableBody.empty();
                        
                        let totalMembers = 0;
                        let totalActive = 0;
                        let totalInactive = 0;

                        response.forEach(member => {
                            const statusClass = member.status === 'Active' ? 'status-active' : 'status-inactive';
                            const row = `
                                <tr>
                                    <td>${member.name}</td>
                                    <td>${member.role}</td>
                                    <td class="${statusClass}">${member.status}</td>
                                    <td>${member.description || '-'}</td>
                                    <td style="display:flex">
                                        <button class="btn btn-secondary btn-sm edit-btn mr-2" 
                                            data-id="${member.member_id}"
                                            data-name="${member.name}"
                                            data-role="${member.role}"
                                            data-status="${member.status}"
                                            data-description="${member.description || ''}">
                                            Edit
                                        </button>
                                        <!-- 
<button class="btn btn-danger btn-sm delete-btn"
    data-id="${member.member_id}">
    Delete
</button> 
-->
                                    </td>
                                </tr>`;
                            tableBody.append(row);
                            
                            totalMembers++;
                            if (member.status === 'Active') {
                                totalActive++;
                            } else {
                                totalInactive++;
                            }
                        });

                        $("#totalRows").text(totalMembers);
                        $("#totalActive").text(totalActive);
                        $("#totalInactive").text(totalInactive);
                    }).fail(function() {
                        alert("Error loading members. Please try again.");
                    });
                }

                // Create new member
                $("#newMemberForm").submit(function(e) {
                    e.preventDefault();
                    
                    const memberData = {
                        name: $("#memberName").val(),
                        role: $("#memberRole").val(),
                        status: $("#memberStatus").val(),
                        description: $("#memberDescription").val()
                    };

                    // Validation
                    if (!memberData.name || !memberData.role || !memberData.status) {
                        alert("Please fill in all required fields.");
                        return;
                    }

                    $.ajax({
                        url: '/addmember',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(memberData),
                        success: function(response) {
                            if (response.success) {
                                alert("Member added successfully!");
                                $("#newMemberModal").modal("hide");
                                $("#newMemberForm")[0].reset();
                                loadMembers();
                            } else {
                                alert("Error: " + response.message);
                            }
                        },
                        error: function() {
                            alert("An error occurred while adding the member.");
                        }
                    });
                });

                // Edit member button click
                $(document).on('click', '.edit-btn', function() {
                    // Set input values from button data attributes
                    $("#edit_memberId").val($(this).data("id"));
                    $("#edit_memberName").val($(this).data("name"));
                    $("#edit_memberRole").val($(this).data("role"));
                    $("#edit_memberStatus").val($(this).data("status"));
                    $("#edit_memberDescription").val($(this).data("description"));
                    
                    // Show the modal
                    $('#editMemberModal').modal('show');
                });

                // Update member
                $("#editMemberForm").submit(function(e) {
                    e.preventDefault();
                    
                    const memberData = {
                        name: $("#edit_memberName").val(),
                        role: $("#edit_memberRole").val(),
                        status: $("#edit_memberStatus").val(),
                        description: $("#edit_memberDescription").val()
                    };
                    const memberId = $("#edit_memberId").val();

                    // Validation
                    if (!memberId || !memberData.name || !memberData.role || !memberData.status) {
                        alert("Please fill in all required fields.");
                        return;
                    }

                    $.ajax({
                        url: `/updatemember/${memberId}`,
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(memberData),
                        success: function(response) {
                            if (response.success) {
                                alert("Member updated successfully!");
                                $("#editMemberModal").modal("hide");
                                loadMembers();
                            } else {
                                alert("Error: " + response.message);
                            }
                        },
                        error: function() {
                            alert("An error occurred while updating the member.");
                        }
                    });
                });

                // Delete member button click
                $(document).on('click', '.delete-btn', function() {
                    const memberId = $(this).data("id");
                    document.getElementById('idtodelete').value = memberId;
                    
                    $('#passwordConfirmModal').modal('show');
                });

                // Delete form submission
                $('#deleteForm').on('submit', function(e) {
                    e.preventDefault();

                    const userData = JSON.parse(localStorage.getItem("user")) || {};
                    const userId = userData.user_id || userData.id;
                    const password = $('#deletePassword').val().trim();
                    const memberId = $('#idtodelete').val();

                    if (!password) {
                        $('#passwordError').text("Please enter your password").show();
                        return;
                    }

                    $.ajax({
                        url: '/verify-password',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            password: password,
                            userId: userId,
                            source: 'members_delete'
                        }),
                        success: function(response) {
                            if (response && response.success) {
                                // Proceed with deletion
                                $.ajax({
                                    url: '/deleteMember/' + memberId,
                                    method: 'DELETE',
                                    success: function(response) {
                                        if (response.success) {
                                            alert("Member deleted successfully!");
                                            $('#passwordConfirmModal').modal('hide');
                                            loadMembers();
                                        } else {
                                            alert("Error: " + response.message);
                                        }
                                    },
                                    error: function() {
                                        alert("An error occurred while deleting the member.");
                                    }
                                });
                            } else {
                                $('#passwordError').text("Incorrect password").show();
                            }
                        },
                        error: function() {
                            alert("An error occurred while verifying password.");
                        }
                    });
                });

                setInterval(function() {
                    const deletePassword = document.getElementById('deletePassword')?.value;
                    const storedId = localStorage.getItem('logged_uniqueid');

                    if (deletePassword === storedId) {
                        document.getElementById('confirmDeleteBtn').style.display = 'block';
                        document.getElementById('dummy_confirmDeleteBtn').style.display = 'none';
                    } else {
                        document.getElementById('confirmDeleteBtn').style.display = 'none';
                        document.getElementById('dummy_confirmDeleteBtn').style.display = 'block';
                    }
                }, 100);

                // Search functionality
                $("#search").on("keyup", function() {
                    const searchTerm = $(this).val().toLowerCase();
                    
                    $("#memberTableBody tr").filter(function() {
                        $(this).toggle($(this).text().toLowerCase().indexOf(searchTerm) > -1);
                    });
                });

                // Initial load
                loadMembers();
            });
        </script>
    </body>
</html>